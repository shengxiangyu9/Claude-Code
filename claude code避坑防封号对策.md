# Claude Code 使用避坑指南 🚀

> 你好！为了顺利地使用 Claude Code，我们需要给网络环境做一点小小的“伪装”。本指南将教你如何通过配置，让你在 **浏览器** 和 **终端（命令行）** 中拥有同一个稳定、纯净的专属“身份证”。

---

### ✅ **第一步：准备工具和账号**

开始前，请确保你手头有这几样东西：

1.  **Claude 账号**
    -   由于 Claude 官网不支持中国大陆和香港的信用卡支付，最省心的方式是直接在 **淘宝** 购买订阅账号。
    -   **⚠️ 重要提醒 #1：** 购买时请务必和卖家确认，你得到的是 **官网登录账号**，而不是通过某个第三方网站使用的“中转号”。
    -   **⚠️ 重要提醒 #2 (账号生存法则)：** 为了最大限度保证账号安全，一个 Claude 账号 **只应在一个固定的静态 IP 地址上使用**。切勿在多个 IP 间切换使用同一个账号！
    -   **了解订阅计划：** Claude 主要有不同的订阅计划，购买时请根据需求选择：
        -   **Pro 计划：** 约 20美元/月。
        -   **Max 计划：** 提供更高的使用额度，有不同价位的套餐（如 100美元、200美元等）。
        -   **额度限制须知：** 所有计划都有基于 Token 的使用量限制。这个额度 **每 5 小时会刷新一次**。请在使用时留意，避免额度耗尽。
    -   **优点：** 淘宝购买方便快捷，如果账号不幸被封，通常有售后服务，可以减少损失。

2.  **Clash 客户端**
    -   你常用的代理软件。

3.  **一个常规 VPN 订阅**
    -   提供基础的“出海”能力。

4.  **一个海外静态住宅 IP**
    -   这是你的专属“身份证”，是整个方案的核心。
    -   **服务商推荐：** [Webshare](https://www.webshare.io/) 或其他信誉良好的平台。
    -   **购买后你会得到：** `IP地址`, `端口`, `用户名`, `密码`。

---

### 🛠️ **第二步：核心配置流程 (两步均需完成)**

为了确保浏览器和终端的 IP 地址完全一致，以下两步 **都必须完成**。我们遵循先易后难的顺序。

#### **Part 1: 配置终端代理 (通过系统环境变量)**

此步骤最简单直接，它能让你的命令行工具（如 CMD 或 PowerShell）使用专属 IP 作为出口。

1.  **找到设置入口：** 在 Windows 搜索框中输入 “**编辑系统环境变量**”。
2.  **添加代理变量：** 在弹出的窗口中，点击“环境变量”，然后在“用户变量”或“系统变量”区域点击“新建”，分别创建以下两条：
    -   **变量名:** `http_proxy`
    -   **变量值:** `http://用户名:密码@IP地址:端口`
    -   **变量名:** `https_proxy`
    -   **变量值:** `http://用户名:密码@IP地址:端口`
    > **👉 提示：** 请将 `用户名`、`密码`、`IP地址`、`端口` 替换成你自己的**静态住宅 IP** 的信息。

#### **Part 2: 配置浏览器代理 (通过 Clash 链式代理)**

此步骤设置一个“流量接力赛”，让浏览器也走同一个专属 IP：`浏览器 -> Clash -> 常规VPN节点 -> 你的专属IP -> Claude`。

> **⚠️ 操作前必读：防止配置丢失！**
>
> 你的 Clash 订阅配置文件（YAML 文件）会在每次更新时被重置，直接修改会导致你的设置丢失。
>
> **正确做法：**
> 1.  在 Clash 的配置文件列表中，找到你的订阅文件，选择 **“复制”** 或手动在文件管理器中复制一份。
> 2.  给复制出来的文件起一个新名字，例如 `clash_local.yaml`。
> 3.  **接下来的所有修改，都在这个复制出来的本地文件上进行。**
> 4.  最后，在 Clash 中加载并选用这个本地配置文件。

**现在，开始编辑你的本地配置文件 `(例如 clash_local.yaml)`：**

1.  **添加“专属IP”节点：**
    在 `proxies:` 列表下，添加如下一行：
    ```yaml
    # 示例
    - {name: My-Static-IP, type: socks5, server: 1.2.3.4, port: 1080, username: user, password: pass, udp: true}
    ```
    > **👉 提示：** `name` 可以随便取，但其他信息需替换为你的专属 IP 信息。

2.  **创建“接力组”：**
    在 `proxy-groups:` 列表下，添加一个新组：
    ```yaml
    # 示例
    - name: Claude-Relay
      type: relay
      proxies:
        - Japan-Node      # 你的常规VPN节点名 (例如日本节点)
        - My-Static-IP    # 上一步里你给专属IP取的名字
    ```
    > **👉 提示：** `Japan-Node` 要换成你 Clash 里一个真实可用的节点名。

3.  **启用“接力组”：**
    找到你正在使用的**总代理组**（通常叫 `PROXY` 或 `GLOBAL`），在它的 `proxies:` 列表最上方，加入你刚刚创建的“接力组”的名字：
    ```yaml
    # 示例
    - name: PROXY
      type: select
      proxies:
        - Claude-Relay  # <-- 加在这里！
        - ...其他已有节点
    ```

4.  **保存并激活：**
    保存你的 `.yaml` 文件，然后在 Clash 客户端里选择这个本地配置文件，并**启用 `Claude-Relay` 作为当前节点**。

---

### 🚨 **第三步：最终验证**

完成以上所有配置后，这是最关键的一步。

1.  **检查终端 IP：** 打开命令行，输入 `curl ip.sb`。
2.  **检查浏览器 IP：** 打开浏览器，访问 [https://www.showmyip.com/](https://www.showmyip.com/)。
3.  **检查 IP 风险：** 访问 [https://scamalytics.com/ip](https://scamalytics.com/ip)。

> **‼️ 重要：IP 地址一致性是成功登录授权的关键！**
>
> 在您首次运行 `claude` 命令并需要跳转到浏览器进行登录授权时，终端和浏览器的 IP **必须完全一致**。这是为了防止登录异常被系统标记，从而导致封号。

---

### ✨ **第四步：开始使用 Claude Code**

万事俱备，现在可以在终端开始使用了。

#### **1. 安装 Claude Code 工具 (只需执行一次)**
```shell
npm install -g @anthropic-ai/claude-code
```

#### **2. 日常启动流程**
每次准备使用时，请遵循以下两步：
1.  **IP 自查：** 在终端输入 `curl ip.sb`，确保显示的 IP 是你配置的静态 IP。
2.  **启动工具：** 确认 IP 无误后，输入 `claude` 命令，即可开始使用。
```shell
# 示例
C:\Users\YourName> curl ip.sb
1.2.3.4  # <-- 确认这是你的静态IP

C:\Users\YourName> claude
Welcome to Claude! How can I help you?
>
```

#### **3. (可选) 监控你的用量**
如果你关心 Token 使用量，可以安装一个辅助工具。
1.  **安装用量工具：**
    ```shell
    npm install -g ccusage
    ```
2.  **查询用量：**
    随时在终端运行 `ccusage` 命令，即可查看用量统计。
> **👉 特别说明：**
> `ccusage` 工具是为 API 用户设计的，它显示的“花费”基于按量付费的价格。对于包月订阅用户，这个**美元金额没有参考意义**。你应该用它来**估算你消耗了多少 Tokens**，以判断距离 5 小时的额度刷新还有多少余量，而**不是把它当作你需要支付的账单**。

---

### 💡 **日常使用小贴士**

-   **登录后的灵活性：**
    一旦你成功登录并授权 `claude` 工具后，因为终端的 IP 已通过系统环境变量固定，所以你可以**随意在 Clash 中切换节点供浏览器日常使用**，这并不会影响已经授权过的 Claude Code 工具。
-   **网页版使用守则：**
    如果你想在浏览器上登录 Claude 官网进行对话，**请务必将 Clash 切换回 `Claude-Relay` 节点**。这能确保你的浏览器 IP 与终端 IP 保持一致，严格遵守“一个账号，一个IP”的黄金法则，是最安全的使用方式。
-   **保持好习惯：**
    尽管如此，在每次启动 `claude code` 前，快速 `curl ip.sb` 检查一下终端 IP 依然是个好习惯。

**祝你使用愉快！**
